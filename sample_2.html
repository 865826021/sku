<!DOCTYPE HTML>
<html>
<head>
    <title>Demo</title>
    <style type="text/css">
        .selected {color: red;}
    </style>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <link rel="stylesheet" href="sku.css"/>
</head>
<body>


<div class="tb-skin  tb-naked ">
    <dl class="tb-prop J_Prop tb-clearfix">
        <dt class="tb-property-type">版本：</dt>
        <dd>
            <ul data-property="版本" class="tb-clearfix J_TSaleProp  ">
                <li data-value="20525:27772" class="J_TAtom">中国大陆</li>
                <li data-value="20525:9507519" class="J_TAtom">港澳台</li>
                <li data-value="20525:29148" class="J_TAtom">欧洲</li>
            </ul>
        </dd>
    </dl>
    <dl class="tb-prop J_Prop tb-clearfix">
        <dt class="tb-property-type">机身颜色：</dt>
        <dd>
            <ul data-property="机身颜色" class="tb-clearfix J_TSaleProp tb-img  ">
                <li data-value="1627207:60092" class="J_TAtom" title="浅黄色" >
                    
                        浅黄色
                    
                    </li>
                <li data-value="1627207:28341" class="J_TAtom" title="黑色" >
                    
                        黑色
                    
                    </li>
                <li data-value="1627207:28338" class="J_TAtom" title="蓝色" >
                    
                        蓝色
                    
                    </li>
                <li data-value="1627207:28332" class="J_TAtom" title="浅灰色" >
                    
                        浅灰色
                    
                    </li>
                <li data-value="1627207:28324" class="J_TAtom" title="黄色" >
                    
                        黄色
                    
                    </li>
                <li data-value="1627207:28320" class="J_TAtom" title="白色" >
                    
                        白色
                    
                    </li>
                <li data-value="1627207:30156" class="J_TAtom" title="浅绿色" >
                    
                        浅绿色
                    
                    </li>
                <li data-value="1627207:3229299" class="J_TAtom" title="红" >
                    
                        红
                    
                    </li>
            </ul>
        </dd>
    </dl>
    <dl class="tb-prop J_Prop tb-clearfix">
        <dt class="tb-property-type">手机套餐：</dt>
        <dd>
            <ul data-property="手机套餐" class="tb-clearfix J_TSaleProp  ">
                <li data-value="1630696:6536025" class="J_TAtom">官方标配</li>
                <li data-value="1630696:3266781" class="J_TAtom">套餐二</li>
                <li data-value="1630696:3266785" class="J_TAtom">套餐三</li>
            </ul>
        </dd>
    </dl>
    <dl class="tb-prop J_Prop tb-clearfix">
        <dt class="tb-property-type">机身内存：</dt>
        <dd>
            <ul data-property="机身内存" class="tb-clearfix J_TSaleProp  ">
                <li data-value="12304035:116177" class="J_TAtom">32G</li>
            </ul>
        </dd>
    </dl>

</div>


<span id="price">--</span>

<script type="text/javascript">


//测试结果集
var data = {
                ";20525:9507519;1627207:30156;1630696:6536025;12304035:116177;":   {
                    "skuId":    "30171814678",
                    "oversold": "true",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3005.00",
                    "stock":    "1"
                },
                ";20525:27772;1627207:28320;1630696:3266781;12304035:116177;":     {
                    "skuId":    "31000442740",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3780.00",
                    "stock":    "650"
                },
                ";20525:27772;1627207:28320;1630696:3266785;12304035:116177;":     {
                    "skuId":    "31000442741",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3670.00",
                    "stock":    "1887"
                },
                ";20525:27772;1627207:28320;1630696:6536025;12304035:116177;":     {
                    "skuId":    "31000442742",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3540.00",
                    "stock":    "699"
                },
                ";20525:27772;1627207:28324;1630696:3266781;12304035:116177;":     {
                    "skuId":    "31000442743",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3780.00",
                    "stock":    "197"
                },
                ";20525:27772;1627207:28324;1630696:3266785;12304035:116177;":     {
                    "skuId":    "31000442744",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3670.00",
                    "stock":    "1999"
                },
                ";20525:27772;1627207:28324;1630696:6536025;12304035:116177;":     {
                    "skuId":    "31000442745",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3540.00",
                    "stock":    "183"
                },
                ";20525:27772;1627207:28332;1630696:3266781;12304035:116177;":     {
                    "skuId":    "31000442746",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3780.00",
                    "stock":    "155"
                },
                ";20525:27772;1627207:28332;1630696:3266785;12304035:116177;":     {
                    "skuId":    "31000442747",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3670.00",
                    "stock":    "154"
                },
                ";20525:27772;1627207:28332;1630696:6536025;12304035:116177;":     {
                    "skuId":    "31000442748",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3540.00",
                    "stock":    "1320"
                },
                ";20525:27772;1627207:28338;1630696:3266781;12304035:116177;":     {
                    "skuId":    "31000442749",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3715.00",
                    "stock":    "147"
                },
                ";20525:27772;1627207:28338;1630696:3266785;12304035:116177;":     {
                    "skuId":    "31000442750",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3605.00",
                    "stock":    "196"
                },
                ";20525:27772;1627207:28338;1630696:6536025;12304035:116177;":     {
                    "skuId":    "31000442751",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3475.00",
                    "stock":    "141"
                },
                ";20525:27772;1627207:28341;1630696:3266781;12304035:116177;":     {
                    "skuId":    "31000442752",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3780.00",
                    "stock":    "554"
                },
                ";20525:27772;1627207:28341;1630696:3266785;12304035:116177;":     {
                    "skuId":    "31000442753",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3670.00",
                    "stock":    "555"
                },
                ";20525:27772;1627207:28341;1630696:6536025;12304035:116177;":     {
                    "skuId":    "31000442754",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3540.00",
                    "stock":    "196"
                },
                ";20525:27772;1627207:3229299;1630696:3266781;12304035:116177;":   {
                    "skuId":    "31000442758",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3690.00",
                    "stock":    "78"
                },
                ";20525:27772;1627207:3229299;1630696:3266785;12304035:116177;":   {
                    "skuId":    "31000442759",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3580.00",
                    "stock":    "188"
                },
                ";20525:27772;1627207:3229299;1630696:6536025;12304035:116177;":   {
                    "skuId":    "31000442760",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3450.00",
                    "stock":    "77"
                },
                ";20525:27772;1627207:60092;1630696:3266781;12304035:116177;":     {
                    "skuId":    "31000442761",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3740.00",
                    "stock":    "15"
                },
                ";20525:27772;1627207:60092;1630696:3266785;12304035:116177;":     {
                    "skuId":    "31000442762",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3630.00",
                    "stock":    "15"
                },
                ";20525:27772;1627207:60092;1630696:6536025;12304035:116177;":     {
                    "skuId":    "31000442763",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3500.00",
                    "stock":    "15"
                },
                ";20525:9507519;1627207:3229299;1630696:3266781;12304035:116177;": {
                    "skuId":    "31000442788",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3550.00",
                    "stock":    "5"
                },
                ";20525:9507519;1627207:3229299;1630696:3266785;12304035:116177;": {
                    "skuId":    "31000442789",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3430.00",
                    "stock":    "5"
                },
                ";20525:9507519;1627207:3229299;1630696:6536025;12304035:116177;": {
                    "skuId":    "31000442790",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3300.00",
                    "stock":    "5"
                },
                ";20525:29148;1627207:28320;1630696:3266781;12304035:116177;":     {
                    "skuId":    "47739320817",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3245.00",
                    "stock":    "133"
                },
                ";20525:29148;1627207:28320;1630696:3266785;12304035:116177;":     {
                    "skuId":    "47739320818",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3135.00",
                    "stock":    "343"
                },
                ";20525:29148;1627207:28320;1630696:6536025;12304035:116177;":     {
                    "skuId":    "47739320819",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3005.00",
                    "stock":    "231"
                },
                ";20525:29148;1627207:28341;1630696:3266781;12304035:116177;":     {
                    "skuId":    "47739320820",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3245.00",
                    "stock":    "379"
                },
                ";20525:29148;1627207:28341;1630696:3266785;12304035:116177;":     {
                    "skuId":    "47739320821",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3135.00",
                    "stock":    "390"
                },
                ";20525:29148;1627207:28341;1630696:6536025;12304035:116177;":     {
                    "skuId":    "47739320822",
                    "oversold": "false",
                    "tagPrice": "",
                    "spPrice":  "",
                    "price":    "3005.00",
                    "stock":    "268"
                }
            }
//保存最后的组合结果信息
var SKUResult = {};
//获得对象的key
function getObjKeys(obj) {
    if (obj !== Object(obj)) throw new TypeError('Invalid object');
    var keys = [];
    for (var key in obj)
        if (Object.prototype.hasOwnProperty.call(obj, key))
            keys[keys.length] = key;
    return keys;
}
//把组合的key放入结果集SKUResult
function add2SKUResult(key, sku) {
    if(SKUResult[key]) {//SKU信息key属性·
        SKUResult[key].count += sku.count;
        SKUResult[key].prices.push(sku.price);
    } else {
        SKUResult[key] = {
            count : sku.count,
            prices : [sku.price]
        };
    }
}
//对一条SKU信息进行拆分组合
function combineSKU(skuKeyAttrs, cnum, sku) {
    var len = skuKeyAttrs.length;
    for(var i = 0; i < len; i++) {
        var key = skuKeyAttrs[i];
        for(var j = i+1; j < len; j++) {
            if(j + cnum <= len) {
                var tempArr = skuKeyAttrs.slice(j, j+cnum);    //安装组合个数获得属性值·
                var genKey = key + ";" + tempArr.join(";");    //得到一个组合key
                add2SKUResult(genKey, sku);
            }
        }
    }
}
//初始化得到结果集
function initSKU() {
    var i, j, skuKeys = getObjKeys(data);
    for(i = 0; i < skuKeys.length; i++) {
        var skuKey = skuKeys[i];//一条SKU信息key
        var sku = data[skuKey];    //一条SKU信息value
        var skuKeyAttrs = skuKey.split(";"); //SKU信息key属性值数组
        var len = skuKeyAttrs.length;

        //对每个SKU信息key属性值进行拆分组合
        for(j = 0; j < len; j++) {
            //单个属性值作为key直接放入SKUResult
            add2SKUResult(skuKeyAttrs[j], sku);
            //对本组SKU信息key属性进行组合，组合个数为j
            (j > 0 && j < len-1) && combineSKU(skuKeyAttrs, j, sku);
        }

        //结果集接放入SKUResult
        SKUResult[skuKey] = {
            count:sku.count,
            prices:[sku.price]
        }
    }
}
//初始化用户选择事件
$(function() {
    initSKU();
    $('.J_TAtom').each(function() {
        var self = $(this);
        var attr_id = self.attr('data-value');
        if(!SKUResult[attr_id]) {
            self.attr('disabled', 'disabled');
        }
    }).click(function() {
        var self = $(this);

        // 切换被点击SKU 的class，去除其所在属性其它的sku 的 class
        self.toggleClass('selected').siblings().removeClass('selected');

        var selectedObjs = $('.selected');
        if(selectedObjs.length) {
            //获得组合key价格
            var selectedIds = [];
            selectedObjs.each(function() {
                selectedIds.push($(this).attr('data-value'));
            });
            selectedIds.sort(function(value1, value2) {
                return parseInt(value1) - parseInt(value2);
            });
            var len = selectedIds.length;
            var prices = SKUResult[selectedIds.join(';')].prices;
            var maxPrice = Math.max.apply(Math, prices);
            var minPrice = Math.min.apply(Math, prices);
            $('#price').text(maxPrice > minPrice ? minPrice + "-" + maxPrice : maxPrice);

            //用已选中的节点验证待测试节点 underTestObjs
            $(".J_TAtom").not(selectedObjs).not(self).each(function() {
                var siblingsSelectedObj = $(this).siblings('.selected');
                var testAttrIds = [];//从选中节点中去掉选中的兄弟节点
                if(siblingsSelectedObj.length) {
                    var siblingsSelectedObjId = siblingsSelectedObj.attr('data-value');
                    for(var i = 0; i < len; i++) {
                        (selectedIds[i] != siblingsSelectedObjId) && testAttrIds.push(selectedIds[i]);
                    }
                } else {
                    testAttrIds = selectedIds.concat();
                }
                testAttrIds = testAttrIds.concat($(this).attr('data-value'));
                testAttrIds.sort(function(value1, value2) {
                    return parseInt(value1) - parseInt(value2);
                });
                if(!SKUResult[testAttrIds.join(';')]) {
                    $(this).addClass('disabled').removeClass('selected');
                } else {
                    $(this).removeClass('disabled');
                }
            });
        } else {
            //设置默认价格
            $('#price').text('--');
            //设置属性状态
            $('.J_TAtom').each(function() {
                SKUResult[$(this).attr('data-value')] ? $(this).removeClass('disabled') : $(this).addClass('disabled').removeClass('selected');
            })
        }
    });
});

</script>
</body>
</html>